<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书馆座位助手 - 座位管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* 座位管理专用样式 */
        :root {
            --seat-empty: #f4e6d8;
            --seat-occupied: #e86a6a;
            --seat-away: #f2c169;
            --seat-d: 56px;
            --line: #d9d4ce;
            --table: #ece7e0;
        }

        .map {
            display: grid;
            gap: 16px;
            margin: 20px 0;
        }

        .wall-row {
            display: grid;
            grid-template-columns: repeat(5, minmax(70px, 1fr));
            gap: 12px;
        }

        .seat-block {
            display: grid;
            justify-items: center;
            gap: 0;
        }

        .wall-row.top .seat-block {
            grid-template-rows: auto calc(var(--seat-d)/2);
        }

        .wall-row.bottom .seat-block {
            grid-template-rows: calc(var(--seat-d)/2) auto;
        }

        .desk {
            width: 100%;
            height: 42px;
            background: var(--table);
            border: 1px solid var(--line);
            border-radius: 10px;
        }

        .seat {
            position: relative;
            width: var(--seat-d);
            height: calc(var(--seat-d) / 2);
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
            place-self: center;
        }

        .seat::before {
            content: "";
            display: block;
            width: 100%;
            height: 100%;
            background: var(--seat-empty);
            box-shadow: inset 0 6px 14px rgba(0,0,0,.05);
            transition: background-color .2s ease;
        }

        .semi-bottom::before {
            border-radius: 0 0 999px 999px;
            margin-top: -1px;
        }

        .semi-top::before {
            border-radius: 999px 999px 0 0;
            margin-bottom: -1px;
        }

        .seat.occupied::before { background: var(--seat-occupied); }
        .seat.away::before { background: var(--seat-away); }

        .label {
            margin-top: 4px;
            font-size: 11px;
            color: #7a7a7a;
            text-align: center;
        }

        .tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        button.action {
            border: 1px solid var(--line);
            background: #fff;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
            cursor: pointer;
        }

        .legend {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #6b6b6b;
            margin-top: 10px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid var(--line);
        }

        .dot.empty { background: var(--seat-empty) }
        .dot.occu { background: var(--seat-occupied) }
        .dot.away { background: var(--seat-away) }

        .seat-popup {
            position: absolute;
            z-index: 1000;
            min-width: 140px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #fff;
            box-shadow: 0 6px 20px rgba(0,0,0,.08);
            font-size: 13px;
        }

        .seat-popup .menu-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .seat-popup .menu-btn {
            border: 1px solid var(--line);
            padding: 6px 10px;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #3498db;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>图书馆座位助手</h1>
        <p>北京师范大学会同书院</p>
    </div>

    <div class="content">
        <div class="card">
            <h1>励行书院有声自习室 · 座位地图</h1>
            <div class="sub">扫描座位上的二维码或轻触 NFC 后，本页会高亮对应座位（红色=有人，米色=无人）。</div>

            <div class="tools">
                <button class="action" id="btn-scan-help">二维码/NFC 接入说明</button>
                <button class="action" id="btn-reset">测试重置（全部置空）</button>
                <button class="action" id="btn-nfc" disabled>读取 NFC（测试）</button>
            </div>

            <div class="map" id="map">
                <div class="wall-row top">
                    <div class="seat-block">
                        <div class="desk" aria-hidden="true"></div>
                        <button class="seat semi-bottom" data-id="T1" aria-label="T1 座位"></button>
                        <div class="label">T1</div>
                    </div>
                    <div class="seat-block">
                        <div class="desk"></div>
                        <button class="seat semi-bottom" data-id="T2" aria-label="T2 座位"></button>
                        <div class="label">T2</div>
                    </div>
                    <div class="seat-block">
                        <div class="desk"></div>
                        <button class="seat semi-bottom" data-id="T3" aria-label="T3 座位"></button>
                        <div class="label">T3</div>
                    </div>
                    <div class="seat-block">
                        <div class="desk"></div>
                        <button class="seat semi-bottom" data-id="T4" aria-label="T4 座位"></button>
                        <div class="label">T4</div>
                    </div>
                    <div class="seat-block">
                        <div class="desk"></div>
                        <button class="seat semi-bottom" data-id="T5" aria-label="T5 座位"></button>
                        <div class="label">T5</div>
                    </div>
                </div>

                <div class="wall-row bottom">
                    <div class="seat-block">
                        <button class="seat semi-top" data-id="B1" aria-label="B1 座位"></button>
                        <div class="desk" aria-hidden="true"></div>
                        <div class="label">B1</div>
                    </div>
                    <div class="seat-block">
                        <button class="seat semi-top" data-id="B2" aria-label="B2 座位"></button>
                        <div class="desk" aria-hidden="true"></div>
                        <div class="label">B2</div>
                    </div>
                    <div class="seat-block">
                        <button class="seat semi-top" data-id="B3" aria-label="B3 座位"></button>
                        <div class="desk" aria-hidden="true"></div>
                        <div class="label">B3</div>
                    </div>
                    <div class="seat-block">
                        <button class="seat semi-top" data-id="B4" aria-label="B4 座位"></button>
                        <div class="desk" aria-hidden="true"></div>
                        <div class="label">B4</div>
                    </div>
                    <div class="seat-block" aria-hidden="true"></div>
                </div>
            </div>

            <div class="legend">
                <span><span class="dot empty"></span> 无人（米色）</span>
                <span><span class="dot occu"></span> 有人（红色）</span>
                <span><span class="dot away"></span> 预留：暂离</span>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="window.location.href = 'main.html?page=seat'">
            <div class="nav-icon">💺</div>
            <div class="nav-label">座位管理</div>
        </div>
        <div class="nav-item" onclick="window.location.href = 'main.html?page=report'">
            <div class="nav-icon">📊</div>
            <div class="nav-label">学习报告</div>
        </div>
        <div class="nav-item" onclick="window.location.href = 'main.html?page=profile'">
            <div class="nav-icon">👤</div>
            <div class="nav-label">个人资料</div>
        </div>
    </div>

    <script>
        // 座位管理功能
        const KEY = "lx_voice_room_occupancy_v1";
        const occupancy = JSON.parse(localStorage.getItem(KEY) || "{}");

        function setSeatState(id, state) {
            const seat = document.querySelector(`.seat[data-id="${id}"]`);
            if (!seat) return;
            seat.classList.remove('occupied', 'away');
            if (state === 'occupied') seat.classList.add('occupied');
            if (state === 'away') seat.classList.add('away');
            occupancy[id] = state;
            localStorage.setItem(KEY, JSON.stringify(occupancy));
        }

        function applyStored() {
            for (const [id, state] of Object.entries(occupancy)) {
                setSeatState(id, state);
            }
        }

        let currentPopup = null;

        function closePopup() {
            if (currentPopup) {
                currentPopup.remove();
                currentPopup = null;
            }
        }

        function showSeatOptions(btn) {
            closePopup();
            const id = btn.dataset.id;
            const rect = btn.getBoundingClientRect();
            const popup = document.createElement('div');
            popup.className = 'seat-popup';
            popup.innerHTML = `
                <div style="margin-bottom:6px;font-weight:600">${id}</div>
                <div class="menu-row">
                    <button class="menu-btn" data-action="away">暂离</button>
                    <button class="menu-btn" data-action="checkout">退座</button>
                </div>
            `;
            document.body.appendChild(popup);

            const pRect = popup.getBoundingClientRect();
            const scrollY = window.scrollY || window.pageYOffset;
            let top = rect.top + scrollY - pRect.height - 8;
            if (top < window.scrollY + 8) top = rect.bottom + scrollY + 8;
            let left = rect.left + (rect.width / 2) - (pRect.width / 2);
            popup.style.top = top + 'px';
            popup.style.left = left + 'px';

            popup.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                if (!action) return;
                if (action === 'away') {
                    setSeatState(id, 'away');
                } else if (action === 'checkout') {
                    setSeatState(id, 'empty');
                }
                closePopup();
            });

            currentPopup = popup;
        }

        function attachDemoToggle() {
            document.querySelectorAll('.seat').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    const state = occupancy[id] || 'empty';
                    if (state === 'empty') {
                        setSeatState(id, 'occupied');
                    } else if (state === 'occupied') {
                        showSeatOptions(btn);
                    } else if (state === 'away') {
                        setSeatState(id, 'occupied');
                    }
                });
            });

            document.addEventListener('click', () => { closePopup(); });
        }

        document.getElementById('btn-reset').addEventListener('click', () => {
            localStorage.removeItem(KEY);
            Object.keys(occupancy).forEach(k => { delete occupancy[k]; });
            document.querySelectorAll('.seat').forEach(s => {
                s.classList.remove('occupied', 'away');
            });
            closePopup();
        });

        document.getElementById('btn-scan-help').addEventListener('click', () => {
            alert('座位管理帮助：点击座位可以切换状态，红色表示有人，米色表示空位');
        });

        // 初始化
        applyStored();
        attachDemoToggle();
    </script>
</body>
</html>